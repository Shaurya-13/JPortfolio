const express=require("express"),path=require("path"),logger=require("morgan"),cookieParser=require("cookie-parser"),bodyParser=require("body-parser"),sessions=require("client-sessions"),templateEngine=require("./template-engine"),db=require("./db"),BASE_PATH=__dirname+"/../../../../",configureSession=e=>{const s=e.opts;if(!s.session)return;const o=s.session.cookieName||"vertexSession",n=s.session.secret||process.env.SESSION_SECRET,r=s.session.duration||864e5,i=s.session.activeDuration||18e5;e.use(sessions({cookieName:o,secret:n,duration:r,activeDuration:i}))},configureDB=e=>{const s=e.opts.db;s&&(null==s.type?db.connect(s.url,s.onError,s.onSuccess):"mongo"==s.type?db.connectMongo(s.url,s.onError,s.onSuccess):"nedb"==s.type?db.connectNedb(s.url,s.onError,s.onSuccess):db.connectMongo(s.url,s.onError,s.onSuccess))};module.exports=((e,s)=>{if(null!=e){e.opts=s||{},e.use(bodyParser.json()),e.use(bodyParser.urlencoded({extended:!1})),e.use(cookieParser()),e.use(logger("dev")),e.opts.viewEngine?e.set("view engine",e.opts.viewEngine):(e.set("view engine","mustache"),e.engine("mustache",templateEngine.__express));var o=e.opts.views?path.join(BASE_PATH,e.opts.views):path.join(BASE_PATH,"views");e.set("views",o);var n=e.opts.static||"public",r=path.join(BASE_PATH,n),i=process.env.TURBO_CDN;if(null!=i&&"prod"===process.env.TURBO_ENV){var t={dotfiles:"ignore",etag:!1,setHeaders:function(e,s,o){var r=i+s.replace("/var/task/"+n,"");e.status(302),e.set("Location",r)}};e.use(express.static(r,t))}else e.use(express.static(r));null!=e.opts.session&&configureSession(e),null!=e.opts.db&&configureDB(e)}});