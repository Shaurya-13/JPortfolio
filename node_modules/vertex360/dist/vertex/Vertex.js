const decode=require("urldecode"),formatCallback=require("./callback"),adminRest=require("./adminRest"),authHandler=require("./authHandler"),Router=require("./Router"),db=require("./db"),generateErrorCallback=(e,t,r)=>{return{isBase64Encoded:!1,statusCode:t,headers:r||{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",data:{message:e.message,stack:e.stack}})}},generateSuccessCallback=(e,t)=>{return{isBase64Encoded:!1,statusCode:200,headers:t||{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"success",data:e})}},logString=e=>{let t=e.httpMethod.toLowerCase().toUpperCase()+" "+e.path;return null!=e.headers["User-Agent"]&&(t+=" "+e.headers["User-Agent"]),null==e.requestContext?t:null==e.requestContext.identity?t:null==e.requestContext.identity.sourceIp?t:t+=" "+e.requestContext.identity.sourceIp};class Vertex{constructor(e){if(this.routes=[],this.middleware=[],this.staticDir="public",this.opts=e,this.logging=!1,null==e)return;this.staticDir=e.static||"public",this.logging=e.logging||!1;const t=e.db;null!=t&&(null==t.type?db.connect(t.url,t.onError,t.onSuccess):"mongo"==t.type?db.connectMongo(t.url,t.onError,t.onSuccess):"nedb"==t.type?db.connectNedb(t.url,t.onError,t.onSuccess):db.connectMongo(t.url,t.onError,t.onSuccess))}expressVersion(e){var t=this;return e.use("/turbo",(e,r,n)=>{r.json({confirmation:"success",data:JSON.stringify(t.routes)})}),t.routes.forEach(t=>{e.use(t.stem,(e,r,n)=>{r.json({confirmation:"success",data:t.stem})})}),e}useStatic(e){this.staticDir=e}use(e,t){null!=t?(t.setStem(e),this.routes.push(t)):this.middleware.push(e)}get(e,t){var r=new Router;r.setStem("/"),r.get(e,t),this.routes.push(r)}post(e,t){var r=new Router;r.setStem("/"),r.post(e,t),this.routes.push(r)}routeNotFound(e,t){e.httpMethod.toLowerCase();return{isBase64Encoded:!1,statusCode:501,headers:{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",message:t})}}handle(e){const t=e.event,r=e.callback,n=t.httpMethod.toLowerCase(),o=t.headers["turbo-vertex-client"];if("admin-dashboard"==o||"mothership"==o){const e=this.opts.controllers||null;return null==e?void r(null,generateErrorCallback(new Error("controllers not defined. check config settings."),500)):void adminRest(e,t).then(e=>{r(null,generateSuccessCallback(e))}).catch(e=>{r(null,generateErrorCallback(e,500))})}if("vertex-sdk"==o){const e=t.path,n=[];e.split("/").forEach(e=>{e.length>0&&"/"!=e&&n.push(e)});const o={message:"site pinged"};return 0==n.length?void r(null,generateSuccessCallback(o)):(n[0],void r(null,generateSuccessCallback(o)))}if("widget-auth"!=o){if(this.logging){const e=logString(t);console.log(e)}if("post"==n){let e=null;for(let r=0;r<this.routes.length;r++){let n=this.routes[r];if(null!=n.handlePost(t)){e=n.handlePost(t);break}}return null==e?void r(null,this.routeNotFound(t,n+" route not defined for this path: "+t.path)):void formatCallback(t,r,e.routeParams,this.opts,this.middleware,(t,n)=>{if(null==t)try{e.routeHandler(n.req,n.res)}catch(t){return void r(null,generateErrorCallback(t,500))}else r(null,generateErrorCallback(t,500))})}if("put"==n){let e=null;for(let r=0;r<this.routes.length;r++){let n=this.routes[r];if(null!=n.handlePut(t)){e=n.handlePut(t);break}}return null==e?void r(null,this.routeNotFound(t,n+" route not defined for this path: "+t.path)):void formatCallback(t,r,e.routeParams,this.opts,this.middleware,(t,n)=>{if(null==t)try{e.routeHandler(n.req,n.res)}catch(t){return void r(null,generateErrorCallback(t,500))}else r(null,generateErrorCallback(t,500))})}if("delete"==n){let e=null;for(let r=0;r<this.routes.length;r++){let n=this.routes[r];if(null!=n.handleDelete(t)){e=n.handleDelete(t);break}}return null==e?void r(null,this.routeNotFound(t,n+" route not defined for this path: "+t.path)):void formatCallback(t,r,e.routeParams,this.opts,this.middleware,(t,n)=>{if(null==t)try{e.routeHandler(n.req,n.res)}catch(t){return void r(null,generateErrorCallback(t,500))}else r(null,generateErrorCallback(t,500))})}if("get"==n){if(-1==t.path.indexOf(".")){let e=null;for(let r=0;r<this.routes.length;r++){let n=this.routes[r];if(null!=n.handleGet(t)){e=n.handleGet(t);break}}return null==e?void r(null,this.routeNotFound(t,n+" route not defined for this path: "+t.path)):void formatCallback(t,r,e.routeParams,this.opts,this.middleware,(t,n)=>{if(null==t)try{e.routeHandler(n.req,n.res)}catch(t){return void r(null,generateErrorCallback(t,500))}else r(null,generateErrorCallback(t,500))})}if(null==t.headers||null==t.headers)return void r(null,{isBase64Encoded:!1,statusCode:500,headers:{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",data:"Missing Turbo-Vertex-App header (headers is null)"})});const e=t.headers["Turbo-Vertex-App"],o=this.staticDir||"public";let l=null;if(null==this.opts){if(null==e)return void r(null,{isBase64Encoded:!1,statusCode:500,headers:{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",data:"Missing Turbo-Vertex-App header"})});l=("cdn.turbo360-vertex.com/"+e+"/"+o+t.path).replace("//","/")}else if(null==this.opts.bucket){if(null==e)return void r(null,{isBase64Encoded:!1,statusCode:500,headers:{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",data:"Missing Turbo-Vertex-App header"})});l=("cdn.turbo360-vertex.com/"+e+"/"+o+t.path).replace("//","/")}else l="s3.amazonaws.com/"+this.opts.bucket+"/"+o+t.path;r(null,{isBase64Encoded:!1,statusCode:301,headers:{Location:"https://"+l},body:""})}}else authHandler(t).then(e=>{const t={"Content-Type":"application/json"};null!=e.cookie&&(t["Set-Cookie"]=e.cookie),r(null,generateSuccessCallback({vertexUser:e.vertexUser},t))}).catch(e=>{r(null,generateErrorCallback(e,500))})}}module.exports=Vertex;