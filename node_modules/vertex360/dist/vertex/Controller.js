const path=require("path"),fs=require("fs"),BASE_DIR=__dirname+"/../../../../",TMP_DIR=process.env.TMP_DIR||"/tmp",LOCAL_DIR=path.join(BASE_DIR,TMP_DIR),defaultMethods=["constructor","get","getById","post","put","delete"];let _TURBO_ENV,_TURBO_API_KEY,_turbo=null;class Controller{constructor(t,e){this._schema=t,_turbo=require("turbo360")({site_id:e.TURBO_APP_ID}),_TURBO_API_KEY=e.TURBO_API_KEY,_TURBO_ENV=e.TURBO_ENV,this.hooks={find:t=>new Promise((e,o)=>{Controller.checkCollectionDB(t).then(t=>{e(t)}).catch(t=>{o(t)})}),save:t=>new Promise((e,o)=>{Controller.syncCollection(t).then(t=>{e(t)}).catch(t=>{o(t)})})};const o=Object.getOwnPropertyNames(Object.getPrototypeOf(this)),n=this;o.forEach(t=>{if("function"!=typeof this[t])return;if(defaultMethods.indexOf(t)>-1){if("constructor"==t)return;const e=this[t];return void(this[t]="get"==t||"getById"==t?async function(){await n.hooks.find(n.collectionName());return e(...arguments)}:async function(){const t=await e(...arguments);if("prod"!==_TURBO_ENV)return t;try{await n.hooks.save(n.collectionName());return t}catch(e){return t}})}const e=this[t];this[t]=async function(){await n.hooks.find(n.collectionName());const t=await e(...arguments);if("prod"!==_TURBO_ENV)return t;try{await n.hooks.save(n.collectionName());return t}catch(e){return t}}})}static checkCollectionDB(t){const e="dev"==_TURBO_ENV?LOCAL_DIR+"/"+t+".db":TMP_DIR+"/"+t+".db";return new Promise((o,n)=>{_turbo.checkCollectionFile(t,e).then(o=>o.found?null:_turbo.loadCollection(t,e,_TURBO_API_KEY)).then(t=>{o(t)}).catch(t=>{n(t)})})}static syncCollection(t){const e="dev"==_TURBO_ENV?LOCAL_DIR+"/"+t+".db":TMP_DIR+"/"+t+".db";return _turbo.syncCollection(t,e,_TURBO_API_KEY)}static parseFilters(t){if(null==t)return null;const e={};return e.sort="asc"==t.sort?"timestamp":"-timestamp",delete t.sort,e.limit=t.limit?parseInt(t.limit):0,delete t.limit,e}collectionName(){return this._schema.collectionName()}schema(){return this._schema.schema()}get(t){return null}getById(t){return null}post(t){return null}put(t,e){return null}delete(t){return null}}module.exports=Controller;